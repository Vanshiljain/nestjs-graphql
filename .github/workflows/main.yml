name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: |
        npm install

    - name: Run Tests
      run: |
        npm test

    - name: Build
      run: |
        npm run build

  deploy:
    runs-on: ubuntu-latest

    needs: build

    steps:
    - name: Deploy to GitHub Pages
      run: |
        echo "Deploying to GitHub Pages..."
        
        # Set Git user information
        git config --global user.email "nihar@gmail.com"
        git config --global user.name "niharkushwah"
        
        # Initialize the Git repository if not already initialized
        git init
        
        # Add remote if not already added
        git remote add origin https://github.com/niharkushwah/nestjs-graphql.git  # Update with your repository URL
        
        # Fetch branches to ensure we have the latest state
        git fetch
        
        # Check if the gh-pages branch exists, create it if not
        if ! git show-ref --quiet refs/heads/gh-pages; then
            git checkout --orphan gh-pages
        else
            git checkout gh-pages
        fi
        
        # Clean the existing files in the branch
        git rm -rf .
        
        # Perform your deployment steps, e.g., copy files or build artifacts
        # For example, if your build artifacts are in a folder called "dist"
        cp -r /path/to/your/artifacts/* .
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
            # Stage and commit changes
            git add .
            git commit -m "Deploy to GitHub Pages"
            
            # Push changes to the gh-pages branch
            git push origin gh-pages --force
        else
            echo "No changes to commit."
        fi
  
    env:
        GITHUB_TOKEN: {access_token}

